name: Actualizar Licencias Taxi

on:
  schedule:
    - cron: '0 7 * * *'   # 07:00 UTC (08:00-09:00 EspaÃ±a)
    - cron: '0 13 * * *'  # 13:00 UTC (14:00-15:00 EspaÃ±a) - Segunda ejecuciÃ³n diaria
  workflow_dispatch:       # EjecuciÃ³n manual

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Para tener todo el histÃ³rico

      - name: ðŸ Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Instalar dependencias
        run: |
          pip install -r requirements.txt
          pip install undetected-chromedriver  # Para evasiÃ³n de detecciÃ³n

      - name: ðŸ”§ Instalar Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable

      - name: ðŸ” Debug - Ver estructura
        run: |
          echo "ðŸ“ Estructura de scripts:"
          ls -la scripts/
          echo ""
          echo "ðŸ“ Estructura de public:"
          ls -la public/ || echo "No existe public/"

      - name: ðŸ•µï¸ Ejecutar Scraper V2
        env:
          SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
        run: |
          cd scripts
          python licencia_scrap_v2.py || python licencia_scrap.py
        # Intenta v2 primero, fallback a v1 si falla

      - name: ðŸ“Š Ejecutar Procesado V2
        run: |
          cd scripts
          python procesado_licen_v2.py || python procesado_licen.py
        # Intenta v2 primero, fallback a v1 si falla

      - name: ðŸ” Verificar outputs
        run: |
          echo "ðŸ“Š Archivos generados:"
          ls -la public/*.json public/*.csv 2>/dev/null || echo "No hay archivos en public/"
          echo ""
          echo "ðŸ“ˆ Contenido web_feed.json (primeras lÃ­neas):"
          head -30 public/web_feed.json 2>/dev/null || echo "No existe web_feed.json"

      - name: ðŸ’¾ Guardar cambios
        run: |
          git config --global user.name 'TaxiBot'
          git config --global user.email 'bot@noreply.github.com'

          # Pull para evitar conflictos
          git pull --rebase origin main || git pull origin main

          # AÃ±adir archivos especÃ­ficos
          git add licencias_totales.json || true
          git add public/web_feed.json || true
          git add public/history_stats.csv || true
          git add public/analisis_licencias_taxi.json || true
          git add backups/ || true

          # Commit si hay cambios
          if ! git diff --staged --quiet; then
            OFERTAS=$(cat public/web_feed.json | grep -o '"volume":[0-9]*' | head -1 | grep -o '[0-9]*' || echo "?")
            PRECIO=$(cat public/web_feed.json | grep -o '"current_price":[0-9]*' | head -1 | grep -o '[0-9]*' || echo "?")
            git commit -m "ðŸ“ˆ Licencias $(date +'%Y-%m-%d %H:%M'): ${OFERTAS} ofertas @ ${PRECIO}â‚¬"
            git push
          else
            echo "No hay cambios para guardar"
          fi
